name: Build container and run API testing

on:
  workflow_dispatch:
    inputs:
      PORT:
        description: 'The port of your application'
        required: true
        default: "3000"
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # Descargar cÃ³digo
      - name: Checkout repository
        uses: actions/checkout@v4

      # Instalar Docker
      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      # ðŸ”¥ Eliminar contenedores previos si existen
      - name: Cleanup old containers
        run: |
          docker rm -f proyecto-final-api || true

      # Construir imagen
      - name: Build Docker image
        run: |
          docker build -t proyecto-final-api:latest .

      # Ejecutar contenedor
      - name: Run container
        run: |
          docker run -d \
            -p ${{ github.event.inputs.PORT || '3000' }}:3000 \
            --name proyecto-final-api \
            proyecto-final-api:latest

          # Esperar a que levante correctamente
          echo "Waiting for container to start..."
          for i in {1..10}; do
            curl -s http://localhost:${{ github.event.inputs.PORT || '3000' }}/openapi && break
            echo "Retrying in 2s..."
            sleep 2
          done

      # Ver contenedores
      - name: Check container status
        run: |
          docker ps
          docker logs proyecto-final-api || true

      # Hurl
      - name: Setup hurl (API testing tool)
        uses: gacts/install-hurl@v1

      # Ejecutar Tests con Hurl
      - name: Test API
        run: |
          hurl \
            --variable host=http://localhost:${{ github.event.inputs.PORT || '3000' }} \
            --error-format long \
            --test session.hurl

      # ðŸ”¥ Limpiar recursos
      - name: Cleanup
        if: always()
        run: |
          docker rm -f proyecto-final-api || true
          docker image rm proyecto-final-api:latest || true
